<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>个人中心 - 萌谷集市</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.staticfile.org/layui/2.8.18/css/layui.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-light">

<!-- 导航栏 -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
    <div class="container">
        <a class="navbar-brand text-pink fw-bold" href="/"><i class="fa-solid fa-gift me-2"></i>萌谷集市</a>
        <div class="ms-auto">
            <a href="/" class="btn btn-outline-secondary btn-sm">返回首页</a>
        </div>
    </div>
</nav>

<div class="container mb-5">
    <div class="row g-4">
        <!-- 左侧：用户概览 -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm text-center p-4 h-100">
                <div class="position-relative d-inline-block mx-auto mb-3">
                    <img th:src="${user.avatar}" class="rounded-circle border border-3 border-white shadow-sm" width="120" height="120">
                    <span th:if="${user.verified}" class="position-absolute bottom-0 end-0 badge rounded-pill bg-success border border-white" title="已实名认证">
                            <i class="fa-solid fa-check"></i> 实名
                        </span>
                </div>
                <h4 class="fw-bold mb-1" th:text="${user.nickname}">用户昵称</h4>
                <p class="text-muted small mb-3" th:text="${'@' + user.username}">@username</p>

                <!-- 信用分 -->
                <div class="bg-light rounded p-3 mb-3">
                    <div class="d-flex justify-content-between small fw-bold mb-1">
                        <span>信用评分</span>
                        <span class="text-pink" th:text="${user.creditScore}">100</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-pink" role="progressbar" th:style="'width: ' + ${user.creditScore > 100 ? 100 : user.creditScore} + '%'"></div>
                    </div>
                    <small class="text-muted d-block mt-2 text-start">
                        <i class="fa-solid fa-shield-halved me-1"></i>
                        <span th:text="${user.verified ? '信用极佳，已实名' : '请尽快完成实名认证'}">状态</span>
                    </small>
                </div>

                <!-- 徽章墙 -->
                <div class="text-start">
                    <p class="small fw-bold text-muted mb-2">我的徽章</p>
                    <div th:if="${user.badges != null}">
                            <span th:each="badge : ${user.badges}" class="badge bg-info bg-opacity-10 text-info me-1 mb-1 border border-info border-opacity-25">
                                <i class="fa-solid fa-medal me-1"></i><span th:text="${badge}"></span>
                            </span>
                    </div>
                    <div th:if="${user.badges == null || user.badges.isEmpty()}" class="text-muted small">暂无徽章，多去交易吧~</div>
                </div>
            </div>
        </div>

        <!-- 右侧：资料编辑 -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0"><i class="fa-solid fa-user-pen me-2 text-pink"></i>编辑资料</h5>
                </div>
                <div class="card-body p-4">
                    <form id="profileForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label text-muted small">昵称</label>
                                <input type="text" class="form-control" name="nickname" th:value="${user.nickname}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small">个性签名</label>
                                <input type="text" class="form-control" name="signature" th:value="${user.signature}" placeholder="写一句二次元台词吧~">
                            </div>
                            <div class="col-12">
                                <label class="form-label text-muted small">我的标签 (用逗号分隔)</label>
                                <input type="text" class="form-control" name="tags" th:value="${user.tags}" placeholder="例如: 刀剑神域粉,手办收藏家">
                            </div>
                            <div class="col-12">
                                <label class="form-label text-muted small">收货地址</label>
                                <textarea class="form-control" name="address" rows="2" th:text="${user.address}" placeholder="请输入默认收货地址"></textarea>
                            </div>

                            <div class="col-12 mt-4">
                                <div class="form-check form-switch p-0 d-flex align-items-center bg-light rounded p-3">
                                    <div class="ms-5">
                                        <input class="form-check-input" type="checkbox" id="verifyCheck" name="verify" value="true" th:checked="${user.verified}" th:disabled="${user.verified}">
                                    </div>
                                    <div class="ms-3">
                                        <label class="form-check-label fw-bold d-block" for="verifyCheck">实名认证申请</label>
                                        <small class="text-muted" th:text="${user.verified ? '您已通过实名认证，信用分加成生效中。' : '勾选提交以进行模拟实名认证，增加20信用分。'}"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-end mt-4">
                            <button type="submit" class="btn btn-pink px-4 rounded-pill">保存修改</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.staticfile.org/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/layui/2.8.18/layui.js"></script>
<script>
    $(document).ready(function() {
        $('#profileForm').on('submit', function(e) {
            e.preventDefault();
            // 简单的表单序列化
            var formData = {};
            $(this).serializeArray().forEach(function(item) {
                formData[item.name] = item.value;
            });
            // 处理 checkbox 未选中时不提交的问题
            if(!formData['verify']) formData['verify'] = 'false';

            $.ajax({
                url: '/api/profile/update',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(res) {
                    if(res.success) {
                        layui.layer.msg('保存成功', {icon: 1, time: 1000}, function() {
                            location.reload();
                        });
                    } else {
                        layui.layer.msg(res.msg, {icon: 2});
                    }
                }
            });
        });
    });
</script>
</body>
</html>