<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>发布商品 - 萌谷集市</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.staticfile.org/layui/2.8.18/css/layui.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="bg-light">

<div class="container my-5" style="max-width: 800px;">
    <div class="card border-0 shadow-lg">
        <div class="card-header bg-white border-0 pt-4 px-5">
            <h3 class="fw-bold text-pink">发布闲置回血</h3>
        </div>
        <div class="card-body p-5">
            <!-- 注意 enctype -->
            <form id="publishForm" enctype="multipart/form-data">
                <h5 class="mb-3 border-start border-4 border-pink ps-2">基本信息</h5>
                <div class="row g-3 mb-4">
                    <div class="col-12">
                        <label class="form-label">商品标题</label>
                        <input type="text" name="title" class="form-control" placeholder="品牌 + IP + 角色 + 特征" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">所属 IP / 作品</label>
                        <input type="text" name="ip" class="form-control" placeholder="如：初音未来、原神" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">分类</label>
                        <select name="category" class="form-select">
                            <option value="手办">手办/模型</option>
                            <option value="画集">画集/设定集</option>
                            <option value="漫画">漫画/周边书籍</option>
                            <option value="周边">徽章/立牌/挂件</option>
                            <option value="盲盒">盲盒/盒蛋</option>
                        </select>
                    </div>
                </div>

                <h5 class="mb-3 border-start border-4 border-pink ps-2">状态与价格</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="form-label">成色</label>
                        <select name="condition" class="form-select">
                            <option value="全新">全新 (未拆封)</option>
                            <option value="99新">99新 (仅拆摆/无瑕)</option>
                            <option value="9成新">9成新 (有细微瑕疵)</option>
                            <option value="二手">二手 (有明显使用痕迹)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">附件情况</label>
                        <select name="accessories" class="form-select">
                            <option value="盒说全">盒说全</option>
                            <option value="有盒无说">有盒无说</option>
                            <option value="无盒有说">无盒有说</option>
                            <option value="仅本体">仅本体/散货</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">价格 (¥)</label>
                        <input type="number" name="price" class="form-control" step="0.01" required>
                    </div>
                </div>

                <h5 class="mb-3 border-start border-4 border-pink ps-2">详细描述</h5>
                <div class="mb-4">
                    <div class="mb-3">
                        <label class="form-label">商品实拍图</label>
                        <!-- 改为文件上传控件 -->
                        <input type="file" name="file" class="form-control" accept="image/*" required>
                        <div class="form-text">支持 jpg, png 格式，最大 10MB。</div>
                    </div>
                    <textarea name="description" class="form-control" rows="5" placeholder="描述一下商品的细节、瑕疵情况、出物原因等..."></textarea>
                </div>

                <div class="form-check form-switch mb-4">
                    <input class="form-check-input" type="checkbox" id="stockStatus" checked>
                    <label class="form-check-label" for="stockStatus">直接上架 (关闭则存为草稿)</label>
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <a href="/" class="btn btn-light rounded-pill px-4">取消</a>
                    <button type="submit" class="btn btn-pink rounded-pill px-5 fw-bold">立即发布</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.staticfile.org/jquery/3.6.4/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/layui/2.8.18/layui.js"></script>
<script>
    $(document).ready(function() {
        $('#publishForm').on('submit', function(e) {
            e.preventDefault();

            // 使用 FormData 处理文件上传
            var formData = new FormData(this);

            // 手动添加 checkbox 的状态 (因为 FormData 不会自动包含未选中的 checkbox 值，或者需要转换逻辑)
            // 这里我们只需传递 status 字段
            formData.append('status', $('#stockStatus').is(':checked') ? 0 : 4);

            const loadIdx = layui.layer.load(2);
            $.ajax({
                url: '/api/trade/publish',
                type: 'POST',
                data: formData,
                // 必须设置以下两项为 false，才能正确发送文件
                processData: false,
                contentType: false,
                success: function(res) {
                    layui.layer.close(loadIdx);
                    if(res.success) {
                        layui.layer.msg('发布成功', {icon: 1, time: 1000}, function() {
                            window.location.href = '/';
                        });
                    } else {
                        if(res.needLogin) {
                            layui.layer.msg('请先登录', {icon:0}, () => location.href='/login');
                        } else {
                            layui.layer.msg(res.msg);
                        }
                    }
                },
                error: function() {
                    layui.layer.close(loadIdx);
                    layui.layer.msg('上传失败，请检查文件大小或网络');
                }
            });
        });
    });
</script>
</body>
</html>